# Work Packages: Interactive Audio Tour Guide

**Inputs**: Design documents from `/kitty-specs/001-interactive-audio-tour/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Testing only included where explicitly beneficial for iOS Chrome compatibility validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/planned/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Single frontend project**: `src/`, `tests/`
- All source in worktree root: `/Users/oskar/git/audio-guide/.worktrees/001-interactive-audio-tour/`

---

## Work Package WP01: Project Setup & Vite Configuration (Priority: P0)

**Goal**: Establish Vite project skeleton with Leaflet dependencies and environment configuration.
**Independent Test**: `npm run dev` starts server, blank page loads without errors in Chrome iOS.
**Prompt**: `tasks/planned/WP01-project-setup.md`

### Included Subtasks
- [ ] T001 Initialize Vite project with vanilla JS template
- [ ] T002 Install dependencies: leaflet, leaflet-gesture-handling
- [ ] T003 [P] Create project directory structure per plan.md
- [ ] T004 [P] Configure environment variables for API keys (VITE_OPENAI_API_KEY, VITE_ELEVENLABS_API_KEY)
- [ ] T005 [P] Add .gitignore with .env exclusion
- [ ] T006 Create index.html with viewport meta tag for iOS
- [ ] T007 Create main.js entry point (empty shell)
- [ ] T008 Create style.css with full-viewport map container styles

### Implementation Notes
1. Use `npm create vite@latest . -- --template vanilla`
2. Viewport meta: `<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />`
3. Map container must be 100vw x 100vh with no overflow

### Parallel Opportunities
- T003, T004, T005 can proceed in parallel after T001/T002

### Dependencies
- None (starting package)

### Risks & Mitigations
- Vite version compatibility: pin to 5.x in package.json

---

## Work Package WP02: Map Display & Tile Loading (Priority: P0)

**Goal**: Display interactive Leaflet map with OpenStreetMap tiles, supporting pan/zoom gestures on iOS Chrome.
**Independent Test**: Map displays, user can pan and pinch-zoom smoothly on iOS Chrome without page zoom conflicts.
**Prompt**: `tasks/planned/WP02-map-display.md`

### Included Subtasks
- [ ] T009 Create `src/components/Map.js` - Leaflet map initialization wrapper
- [ ] T010 Configure Leaflet with GestureHandling plugin for iOS
- [ ] T011 Add OpenStreetMap tile layer with attribution
- [ ] T012 Set default center (fallback location) and zoom level
- [ ] T013 Export map instance and viewport change events
- [ ] T014 Create `src/utils/debounce.js` utility for map events

### Implementation Notes
1. Initialize map with `gestureHandling: true`, `tap: true`, `touchZoom: true`
2. Default center: central Europe or configurable
3. Emit `moveend` and `zoomend` events for attraction loading

### Parallel Opportunities
- T014 can proceed independently

### Dependencies
- Depends on WP01

### Risks & Mitigations
- iOS WebKit rendering: test on actual iOS device, not just simulator

---

## Work Package WP03: User Location & Compass Heading (Priority: P1)

**Goal**: Display user's current location as a directional arrow marker that rotates based on compass heading.
**Independent Test**: Arrow marker appears at user location, rotates when device orientation changes.
**Prompt**: `tasks/planned/WP03-user-location.md`

### Included Subtasks
- [ ] T015 Create `src/services/geolocation.js` - Browser Geolocation API wrapper
- [ ] T016 Implement `watchPosition` with error handling and permission flow
- [ ] T017 Create `src/services/orientation.js` - Device compass heading service
- [ ] T018 Implement iOS-specific `webkitCompassHeading` with permission request
- [ ] T019 Create `src/components/UserMarker.js` - Directional arrow marker component
- [ ] T020 Design arrow SVG/CSS that rotates based on heading
- [ ] T021 Center map on user location when first acquired
- [ ] T022 Handle location permission denial gracefully (show message, allow manual navigation)

### Implementation Notes
1. Use research.md pattern for DeviceOrientationEvent.requestPermission()
2. Permission request MUST be triggered by user gesture (button click)
3. Fallback: static north-facing arrow if compass unavailable
4. Update heading on throttled interval (100ms per research.md)

### Parallel Opportunities
- T015-T016 (geolocation) and T017-T018 (orientation) can proceed in parallel
- T019-T020 (marker) can start once interfaces are defined

### Dependencies
- Depends on WP02 (needs map instance)

### Risks & Mitigations
- iOS 13+ permission flow: test permission denied path
- Some devices lack compass sensor: graceful degradation

---

## Work Package WP04: Tourist Attractions Loading (Priority: P1) ðŸŽ¯ MVP

**Goal**: Query Overpass API for tourist attractions within map viewport and display as speaker icon markers.
**Independent Test**: Moving/zooming map loads and displays speaker icons for nearby attractions (museums, monuments, etc.).
**Prompt**: `tasks/planned/WP04-attractions-loading.md`

### Included Subtasks
- [ ] T023 Create `src/services/overpass.js` - Overpass API client
- [ ] T024 Implement bounding box query for tourism/historic/amenity tags
- [ ] T025 Add response transformation to Attraction[] per data-model.md
- [ ] T026 Implement debounced fetch on map moveend/zoomend (500ms)
- [ ] T027 Add retry logic with exponential backoff for rate limiting
- [ ] T028 Create `src/components/AttractionMarker.js` - Speaker icon marker
- [ ] T029 Design speaker icon SVG with click/tap affordance
- [ ] T030 [P] Add loading indicator during attraction fetch
- [ ] T031 Handle "no attractions found" state with user message
- [ ] T032 Filter out attractions without names

### Implementation Notes
1. Use contracts/overpass-api.md query template exactly
2. Bounding box format: `(south, west, north, east)` - NOT lat/lng pairs
3. Only show attractions with `tags.name` present
4. Limit markers to ~50-100 to avoid iOS performance issues

### Parallel Opportunities
- T028-T029 (marker component) can proceed in parallel with T023-T027 (API)
- T030 (loading indicator) is independent

### Dependencies
- Depends on WP02 (map viewport bounds)

### Risks & Mitigations
- Overpass rate limiting: aggressive debouncing, exponential backoff
- Too many markers: consider clustering or viewport-based limiting

---

## Work Package WP05: Audio Guide Generation Pipeline (Priority: P2)

**Goal**: Implement the full pipeline: click attraction â†’ fetch facts â†’ generate script â†’ synthesize audio.
**Independent Test**: Clicking a speaker icon triggers loading states and produces playable audio.
**Prompt**: `tasks/planned/WP05-audio-generation.md`

### Included Subtasks
- [ ] T033 Create `src/services/openai.js` - OpenAI API client
- [ ] T034 Implement `generateFacts(attraction)` per contracts/openai-api.md
- [ ] T035 Implement `generateScript(attractionName, facts)` per contracts/openai-api.md
- [ ] T036 Create `src/services/elevenlabs.js` - ElevenLabs TTS client
- [ ] T037 Implement `generateAudio(script)` returning Blob per contracts/elevenlabs-api.md
- [ ] T038 Create `src/utils/config.js` - Environment variable access helper
- [ ] T039 Create audio generation orchestrator combining all three steps
- [ ] T040 Implement AbortController for cancellable requests
- [ ] T041 [P] Create `src/components/LoadingIndicator.js` with multi-step progress
- [ ] T042 Display step-specific loading states (fetching facts, generating script, generating audio)
- [ ] T043 Handle API errors with user-friendly messages and retry button

### Implementation Notes
1. Use exact prompts from contracts/openai-api.md
2. Use voice_id `21m00Tcm4TlvDq8ikWAM` (Rachel) per contracts/elevenlabs-api.md
3. All API keys from `import.meta.env.VITE_*`
4. Total generation should target <20 seconds (SC-003)

### Parallel Opportunities
- T033-T035 (OpenAI) and T036-T037 (ElevenLabs) can proceed in parallel
- T041 (loading indicator) is independent

### Dependencies
- Depends on WP04 (attraction selection)

### Risks & Mitigations
- Generation latency >20s: show progress, allow cancellation (T040)
- API quota exceeded: surface clear error message

---

## Work Package WP06: Audio Playback Controls (Priority: P2)

**Goal**: Provide play/pause controls for generated audio with iOS Chrome compatibility.
**Independent Test**: Play button appears after generation, audio plays through device speakers, pause/resume works.
**Prompt**: `tasks/planned/WP06-audio-playback.md`

### Included Subtasks
- [ ] T044 Create `src/services/audio.js` - Audio playback service
- [ ] T045 Implement iOS audio unlock pattern (silent audio on first user interaction)
- [ ] T046 Create Blob URL management with cleanup on playback end
- [ ] T047 Create `src/components/AudioPlayer.js` - Play/pause UI component
- [ ] T048 Design play/pause button with clear visual states
- [ ] T049 Handle audio end event (return to play state)
- [ ] T050 Position audio player on map UI (floating control)
- [ ] T051 Implement replay capability

### Implementation Notes
1. Use research.md pattern for unlockAudioForIOS()
2. MIME type MUST be `audio/mpeg` for iOS compatibility
3. Clean up Blob URLs to prevent memory leaks
4. Audio must start within 1 second of clicking play (SC-005)

### Parallel Opportunities
- T044-T046 (audio service) and T047-T050 (UI) can proceed in parallel

### Dependencies
- Depends on WP05 (generated audio blob)

### Risks & Mitigations
- iOS autoplay policy: unlock on first attraction click
- Memory leaks: revoke Blob URLs in cleanup

---

## Work Package WP07: Multi-Attraction Flow & State Management (Priority: P3)

**Goal**: Enable seamless switching between attractions, cancelling in-progress generation when selecting a new one.
**Independent Test**: Selecting a new attraction while audio is generating/playing stops the current and starts the new.
**Prompt**: `tasks/planned/WP07-multi-attraction-flow.md`

### Included Subtasks
- [ ] T052 Create `src/state/AppState.js` - Global application state management
- [ ] T053 Implement state transitions per data-model.md AudioGuideStatus
- [ ] T054 Handle attraction selection during active generation (cancel and restart)
- [ ] T055 Handle attraction selection during playback (stop and start new)
- [ ] T056 Update map markers when viewport changes (remove out-of-view markers)
- [ ] T057 Provide visual feedback for selected attraction marker
- [ ] T058 [P] Add cancel button for in-progress generation

### Implementation Notes
1. Use AbortController to cancel fetch requests on new selection
2. Stop audio playback and revoke Blob URL before starting new
3. Selected marker should have distinct visual style (highlight/scale)

### Parallel Opportunities
- T058 (cancel button) can proceed independently

### Dependencies
- Depends on WP05 and WP06

### Risks & Mitigations
- Race conditions: proper abort handling, single source of truth for state

---

## Work Package WP08: Error Handling & Edge Cases (Priority: P3)

**Goal**: Comprehensive error handling for all failure modes identified in spec.md edge cases.
**Independent Test**: App gracefully handles network errors, permission denial, API failures, and shows appropriate messages.
**Prompt**: `tasks/planned/WP08-error-handling.md`

### Included Subtasks
- [ ] T059 Implement error boundary for uncaught exceptions
- [ ] T060 Add network connectivity detection
- [ ] T061 Display timeout warnings after 30 seconds
- [ ] T062 Create reusable error message component
- [ ] T063 Handle geolocation permission denial (manual navigation mode)
- [ ] T064 Handle Overpass API errors (429, 504) with retry UI
- [ ] T065 Handle OpenAI API errors (401, 429, quota) with clear messages
- [ ] T066 Handle ElevenLabs API errors (401, 429, quota) with clear messages
- [ ] T067 Ensure partial failures don't break other features

### Implementation Notes
1. Each error type should map to a user-friendly message
2. Retry buttons should only appear for retryable errors
3. Critical: user should always be able to continue using other features

### Parallel Opportunities
- Error handling for each API (T064, T065, T066) can proceed in parallel

### Dependencies
- Depends on WP03, WP04, WP05, WP06

### Risks & Mitigations
- Error message overload: prioritize most actionable error

---

## Work Package WP09: Polish & Validation (Priority: P4)

**Goal**: Final polish, performance optimization, and validation against quickstart.md scenarios.
**Independent Test**: All quickstart.md manual testing checklist items pass on Chrome iOS.
**Prompt**: `tasks/planned/WP09-polish-validation.md`

### Included Subtasks
- [ ] T068 Validate SC-001: Location appears within 5 seconds
- [ ] T069 Validate SC-002: Attractions load within 3 seconds
- [ ] T070 Validate SC-003: Audio generation under 20 seconds
- [ ] T071 Validate SC-004: Map interactions are immediate
- [ ] T072 Validate SC-005: Audio playback starts within 1 second
- [ ] T073 Test on actual iOS Chrome device (not simulator)
- [ ] T074 Verify all quickstart.md manual testing checklist items
- [ ] T075 Performance audit: ensure <100 markers, efficient re-renders
- [ ] T076 Memory audit: verify Blob URL cleanup
- [ ] T077 Final code cleanup and unused import removal

### Implementation Notes
1. Use quickstart.md testing checklist as acceptance guide
2. Test on real iPhone with Chrome browser
3. Verify all success criteria from spec.md

### Parallel Opportunities
- Validation tasks (T068-T072) can proceed in parallel

### Dependencies
- Depends on all previous work packages

### Risks & Mitigations
- iOS-specific bugs: test on multiple iOS versions if possible

---

## Dependency & Execution Summary

```
WP01 (Setup)
  â””â”€â–º WP02 (Map Display)
        â”œâ”€â–º WP03 (User Location)
        â””â”€â–º WP04 (Attractions) ðŸŽ¯ MVP milestone
              â””â”€â–º WP05 (Audio Generation)
                    â””â”€â–º WP06 (Audio Playback)
                          â””â”€â–º WP07 (Multi-Attraction)
                                â””â”€â–º WP08 (Error Handling)
                                      â””â”€â–º WP09 (Polish)
```

- **Sequence**: WP01 â†’ WP02 â†’ (WP03 || WP04) â†’ WP05 â†’ WP06 â†’ WP07 â†’ WP08 â†’ WP09
- **Parallelization**: WP03 and WP04 can proceed in parallel after WP02
- **MVP Scope**: WP01 through WP04 delivers a working map with user location and attractions visible (User Story 1 complete)
- **Core Feature**: WP05 + WP06 delivers the audio tour capability (User Story 2 complete)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Initialize Vite project | WP01 | P0 | No |
| T002 | Install dependencies | WP01 | P0 | No |
| T003 | Create directory structure | WP01 | P0 | Yes |
| T004 | Configure env variables | WP01 | P0 | Yes |
| T005 | Add .gitignore | WP01 | P0 | Yes |
| T006 | Create index.html | WP01 | P0 | No |
| T007 | Create main.js entry | WP01 | P0 | No |
| T008 | Create style.css | WP01 | P0 | No |
| T009 | Create Map.js component | WP02 | P0 | No |
| T010 | Configure GestureHandling | WP02 | P0 | No |
| T011 | Add tile layer | WP02 | P0 | No |
| T012 | Set default center/zoom | WP02 | P0 | No |
| T013 | Export map events | WP02 | P0 | No |
| T014 | Create debounce utility | WP02 | P0 | Yes |
| T015 | Create geolocation service | WP03 | P1 | No |
| T016 | Implement watchPosition | WP03 | P1 | No |
| T017 | Create orientation service | WP03 | P1 | Yes |
| T018 | Implement compass heading | WP03 | P1 | Yes |
| T019 | Create UserMarker component | WP03 | P1 | No |
| T020 | Design arrow marker | WP03 | P1 | No |
| T021 | Center on user location | WP03 | P1 | No |
| T022 | Handle permission denial | WP03 | P1 | No |
| T023 | Create Overpass service | WP04 | P1 | No |
| T024 | Implement bounding box query | WP04 | P1 | No |
| T025 | Transform API response | WP04 | P1 | No |
| T026 | Debounced fetch on map move | WP04 | P1 | No |
| T027 | Retry with backoff | WP04 | P1 | No |
| T028 | Create AttractionMarker | WP04 | P1 | Yes |
| T029 | Design speaker icon | WP04 | P1 | Yes |
| T030 | Add loading indicator | WP04 | P1 | Yes |
| T031 | Handle no attractions | WP04 | P1 | No |
| T032 | Filter unnamed attractions | WP04 | P1 | No |
| T033 | Create OpenAI service | WP05 | P2 | No |
| T034 | Implement generateFacts | WP05 | P2 | No |
| T035 | Implement generateScript | WP05 | P2 | No |
| T036 | Create ElevenLabs service | WP05 | P2 | Yes |
| T037 | Implement generateAudio | WP05 | P2 | Yes |
| T038 | Create config utility | WP05 | P2 | Yes |
| T039 | Create orchestrator | WP05 | P2 | No |
| T040 | Implement AbortController | WP05 | P2 | No |
| T041 | Create LoadingIndicator | WP05 | P2 | Yes |
| T042 | Step-specific loading states | WP05 | P2 | No |
| T043 | Handle API errors | WP05 | P2 | No |
| T044 | Create audio service | WP06 | P2 | No |
| T045 | Implement iOS unlock | WP06 | P2 | No |
| T046 | Blob URL management | WP06 | P2 | No |
| T047 | Create AudioPlayer component | WP06 | P2 | Yes |
| T048 | Design play/pause button | WP06 | P2 | Yes |
| T049 | Handle audio end | WP06 | P2 | No |
| T050 | Position audio player | WP06 | P2 | No |
| T051 | Implement replay | WP06 | P2 | No |
| T052 | Create AppState | WP07 | P3 | No |
| T053 | Implement state transitions | WP07 | P3 | No |
| T054 | Cancel on new selection | WP07 | P3 | No |
| T055 | Stop playback on new | WP07 | P3 | No |
| T056 | Update markers on viewport | WP07 | P3 | No |
| T057 | Selected marker feedback | WP07 | P3 | No |
| T058 | Add cancel button | WP07 | P3 | Yes |
| T059 | Error boundary | WP08 | P3 | No |
| T060 | Network detection | WP08 | P3 | No |
| T061 | Timeout warnings | WP08 | P3 | No |
| T062 | Error message component | WP08 | P3 | No |
| T063 | Geolocation denial handling | WP08 | P3 | Yes |
| T064 | Overpass error handling | WP08 | P3 | Yes |
| T065 | OpenAI error handling | WP08 | P3 | Yes |
| T066 | ElevenLabs error handling | WP08 | P3 | Yes |
| T067 | Partial failure isolation | WP08 | P3 | No |
| T068 | Validate SC-001 | WP09 | P4 | Yes |
| T069 | Validate SC-002 | WP09 | P4 | Yes |
| T070 | Validate SC-003 | WP09 | P4 | Yes |
| T071 | Validate SC-004 | WP09 | P4 | Yes |
| T072 | Validate SC-005 | WP09 | P4 | Yes |
| T073 | Test on iOS device | WP09 | P4 | No |
| T074 | Quickstart checklist | WP09 | P4 | No |
| T075 | Performance audit | WP09 | P4 | No |
| T076 | Memory audit | WP09 | P4 | No |
| T077 | Code cleanup | WP09 | P4 | No |
