# Work Packages: Backend API for Audio Generation

**Inputs**: Design documents from `/kitty-specs/001-backend-api-for/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: No explicit testing requested. Manual verification only.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/001-backend-api-for/tasks/planned/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Project Setup (Priority: P0)

**Goal**: Initialize Go backend project structure with build configuration.
**Independent Test**: `go build` succeeds and produces executable; Dockerfile builds successfully.
**Prompt**: `tasks/planned/WP01-project-setup.md`

### Included Subtasks
- [ ] T001 Initialize Go module in `backend/`
- [ ] T002 Create `backend/main.go` with HTTP server skeleton
- [ ] T003 [P] Create `backend/Dockerfile` for Cloud Run

### Implementation Notes
- Use Go 1.21+
- Use `net/http` stdlib only (no external frameworks)
- Dockerfile should use multi-stage build for smaller image
- Server listens on `PORT` env var (Cloud Run requirement)

### Parallel Opportunities
- T003 (Dockerfile) can be created in parallel with T002 once module is initialized

### Dependencies
- None (starting package)

### Risks & Mitigations
- Go version mismatch ‚Üí specify in go.mod

---

## Work Package WP02: Core Audio Generation (Priority: P1) üéØ MVP

**Goal**: Implement the complete audio generation pipeline - OpenAI facts ‚Üí OpenAI script ‚Üí ElevenLabs audio.
**Independent Test**: `curl -X POST localhost:8080/generate-audio -d '{"name":"Test","category":"test","latitude":0,"longitude":0}'` returns MP3 audio.
**Prompt**: `tasks/planned/WP02-core-audio-generation.md`

### Included Subtasks
- [ ] T004 [P] Implement OpenAI service - facts generation in `backend/services/openai.go`
- [ ] T005 [P] Implement OpenAI service - script generation in `backend/services/openai.go`
- [ ] T006 [P] Implement ElevenLabs service in `backend/services/elevenlabs.go`
- [ ] T007 Implement `/generate-audio` handler in `backend/handlers/audio.go`
- [ ] T008 Add request validation (name, category, lat, lng required)
- [ ] T009 Add CORS middleware (allow all origins)
- [ ] T010 [P] Add `/health` endpoint

### Implementation Notes
1. Port existing prompts from `src/services/openai.js` exactly
2. Port ElevenLabs settings from `src/services/elevenlabs.js` exactly
3. Handler orchestrates: validate ‚Üí facts ‚Üí script ‚Üí audio ‚Üí return MP3
4. Response: `Content-Type: audio/mpeg` for success, `application/json` for errors
5. CORS headers on all responses including errors

### Parallel Opportunities
- T004, T005, T006 can all proceed in parallel (independent service files)
- T010 (/health) is independent of main flow

### Dependencies
- Depends on WP01 (project structure must exist)

### Risks & Mitigations
- API key not set ‚Üí clear error message on startup
- OpenAI rate limits ‚Üí will be handled in WP03

---

## Work Package WP03: Error Handling (Priority: P2)

**Goal**: Map API errors to user-friendly messages; handle timeouts gracefully.
**Independent Test**: Simulate API failures and verify user-friendly JSON error responses.
**Prompt**: `tasks/planned/WP03-error-handling.md`

### Included Subtasks
- [ ] T011 Implement error mapping utility (API errors ‚Üí user messages)
- [ ] T012 Handle OpenAI-specific errors (401, 429, 422, timeout)
- [ ] T013 Handle ElevenLabs-specific errors (401, 429, timeout)
- [ ] T014 Add request timeout handling (context with deadline)

### Implementation Notes
- Error mapping table from research.md:
  - 401 ‚Üí "Service configuration error. Please try again later."
  - 429 ‚Üí "Service is busy. Please wait a moment and try again."
  - Timeout ‚Üí "Request timed out. Please try again."
  - Unknown ‚Üí "An unexpected error occurred. Please try again."
- Use `context.WithTimeout` for request-level timeouts (90s total)
- Never expose raw API error messages or API keys

### Parallel Opportunities
- T012 and T013 can proceed in parallel once T011 is done

### Dependencies
- Depends on WP02 (core services must exist)

### Risks & Mitigations
- Cascading timeouts ‚Üí ensure per-service timeouts sum to less than total

---

## Work Package WP04: GCP Cloud Run Deployment (Priority: P3)

**Goal**: Deploy backend to GCP Cloud Run with secure API key configuration.
**Independent Test**: `curl https://[deployed-url]/health` returns `{"status":"ok"}`.
**Prompt**: `tasks/planned/WP04-cloud-run-deployment.md`

### Included Subtasks
- [ ] T015 Deploy to GCP Cloud Run using `gcloud run deploy`
- [ ] T016 Configure environment variables (OPENAI_API_KEY, ELEVENLABS_API_KEY)
- [ ] T017 Verify deployed endpoint works with real request

### Implementation Notes
- Deployment command:
  ```bash
  gcloud run deploy audio-guide-api \
    --source ./backend \
    --region us-central1 \
    --allow-unauthenticated \
    --set-env-vars "OPENAI_API_KEY=$OPENAI_API_KEY,ELEVENLABS_API_KEY=$ELEVENLABS_API_KEY" \
    --memory 256Mi \
    --timeout 120 \
    --max-instances 1
  ```
- Ensure Cloud Run API is enabled: `gcloud services enable run.googleapis.com`
- Record deployed URL for WP05

### Parallel Opportunities
- None (sequential deployment steps)

### Dependencies
- Depends on WP02, WP03 (backend must be complete)

### Risks & Mitigations
- Cold start latency ‚Üí acceptable per spec (up to 90s)
- API keys exposed in command history ‚Üí use secrets manager or env file

---

## Work Package WP05: Frontend Integration (Priority: P1)

**Goal**: Update frontend to call backend API; remove exposed API keys.
**Independent Test**: Browser dev tools show no API keys; audio plays via backend.
**Prompt**: `tasks/planned/WP05-frontend-integration.md`

### Included Subtasks
- [ ] T018 Create `src/services/audioApi.js` - backend client
- [ ] T019 Update `src/services/audioGuideGenerator.js` to use audioApi.js
- [ ] T020 Remove `VITE_OPENAI_API_KEY` from `.env` and code
- [ ] T021 Remove `VITE_ELEVENLABS_API_KEY` from `.env` and code
- [ ] T022 Add `VITE_BACKEND_URL` to `.env` configuration

### Implementation Notes
- audioApi.js is a simple fetch wrapper:
  ```javascript
  export async function generateAudioGuide(attraction, signal) {
    const response = await fetch(`${BACKEND_URL}/generate-audio`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(attraction),
      signal
    });
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error);
    }
    return response.blob();
  }
  ```
- Update audioGuideGenerator.js to call this single function instead of three steps
- For local dev, use `VITE_BACKEND_URL=http://localhost:8080`
- For production, use deployed Cloud Run URL

### Parallel Opportunities
- T020, T021, T022 can proceed in parallel (independent config changes)

### Dependencies
- Depends on WP04 (need deployed URL for production config)
- Can start with WP02 using localhost for local testing

### Risks & Mitigations
- CORS errors ‚Üí verified in WP02
- Old cached code exposing keys ‚Üí hard refresh / clear cache

---

## Dependency & Execution Summary

```
WP01 (Setup)
    ‚Üì
WP02 (Core Audio) ‚Üê‚îÄ‚îÄ MVP Scope
    ‚Üì
WP03 (Error Handling)
    ‚Üì
WP04 (Deployment)
    ‚Üì
WP05 (Frontend Integration)
```

- **Sequence**: WP01 ‚Üí WP02 ‚Üí WP03 ‚Üí WP04 ‚Üí WP05
- **Parallelization**: Within WP02, services can be developed in parallel
- **MVP Scope**: WP01 + WP02 delivers a working local backend

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Initialize Go module | WP01 | P0 | No |
| T002 | Create main.go server skeleton | WP01 | P0 | No |
| T003 | Create Dockerfile | WP01 | P0 | Yes |
| T004 | OpenAI facts generation service | WP02 | P1 | Yes |
| T005 | OpenAI script generation service | WP02 | P1 | Yes |
| T006 | ElevenLabs audio service | WP02 | P1 | Yes |
| T007 | /generate-audio handler | WP02 | P1 | No |
| T008 | Request validation | WP02 | P1 | No |
| T009 | CORS middleware | WP02 | P1 | No |
| T010 | /health endpoint | WP02 | P1 | Yes |
| T011 | Error mapping utility | WP03 | P2 | No |
| T012 | OpenAI error handling | WP03 | P2 | Yes |
| T013 | ElevenLabs error handling | WP03 | P2 | Yes |
| T014 | Request timeout handling | WP03 | P2 | No |
| T015 | Deploy to Cloud Run | WP04 | P3 | No |
| T016 | Configure env vars | WP04 | P3 | No |
| T017 | Verify deployment | WP04 | P3 | No |
| T018 | Create audioApi.js | WP05 | P1 | No |
| T019 | Update audioGuideGenerator.js | WP05 | P1 | No |
| T020 | Remove VITE_OPENAI_API_KEY | WP05 | P1 | Yes |
| T021 | Remove VITE_ELEVENLABS_API_KEY | WP05 | P1 | Yes |
| T022 | Add VITE_BACKEND_URL | WP05 | P1 | Yes |
